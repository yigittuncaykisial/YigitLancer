@* FOOTER İLE UYUMLU KOYU TEMA *@
@inject Services.Contracts.ICategoryService _categoryService
@using System.Security.Claims

@{
    var categories = _categoryService?.GetAllCategories() ?? Enumerable.Empty<Entities.Models.Category>();
    var currentUserJob = User.Claims.FirstOrDefault(c => c.Type == "UserJob")?.Value ?? "Buyer";
    var profileImage = User.Claims.FirstOrDefault(c => c.Type == "ProfileImagePath")?.Value ?? "/uploads/default.png";
    var isAuth = User?.Identity?.IsAuthenticated ?? false;
    var currentController = ViewContext.RouteData.Values["controller"]?.ToString();
}

<nav class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom border-secondary-subtle sticky-top shadow-sm">
    <div class="container">
        <a class="navbar-brand fw-bold d-flex align-items-center" asp-controller="Home" asp-action="Index">
            <i class="bi bi-lightning-charge-fill me-2"></i> Lancer
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
                aria-controls="mainNav" aria-expanded="false" aria-label="Menüyü Aç">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="mainNav">
            <!-- Sol: menüler -->
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">

                <!-- Kategoriler (dropdown) -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle @(currentController == "Jobs" ? "active" : "")"
                       href="#" role="button" data-bs-toggle="dropdown">Kategoriler</a>
                    <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-scroll">
                        @if (categories.Any())
                        {
                            @foreach (var c in categories)
                            {
                                <li>
                                    <a class="dropdown-item"
                                       asp-controller="Jobs" asp-action="Index" asp-route-categoryId="@c.Id">
                                        @c.CategoryName
                                    </a>
                                </li>
                            }
                        }
                        else
                        {
                            <li><span class="dropdown-item text-secondary">Kategori yok</span></li>
                        }
                    </ul>
                </li>

                <li class="nav-item">
                    <a class="nav-link @(currentController == "Freelancers" ? "active" : "")"
                       asp-controller="Freelancers" asp-action="Index">Freelancers</a>
                </li>

                @if (currentUserJob == "Freelancer")
                {
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle @(currentController == "Jobs" ? "active" : "")"
                           href="#" role="button" data-bs-toggle="dropdown">İlan İşlemleri</a>
                        <ul class="dropdown-menu dropdown-menu-dark">
                            <li>
                                <a class="dropdown-item" asp-controller="Jobs" asp-action="Create">
                                    <i class="bi bi-plus-circle me-1"></i> İlan Ekle
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" asp-controller="FreelancerPanel" asp-action="MyJobs">
                                    <i class="bi bi-briefcase me-1"></i> İşlerim
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item d-flex align-items-center justify-content-between"
                                   asp-controller="FreelancerPanel" asp-action="Pending">
                                    <span><i class="bi bi-hourglass-split me-1"></i> Onay Bekleyenler</span>
                                    <span id="pendingBadgeNav" class="badge bg-secondary">0</span>
                                </a>
                            </li>
                        </ul>
                    </li>
                }
            </ul>



            <!-- Sağ: Döviz + profil -->
            <ul class="navbar-nav mb-2 mb-lg-0">

                <!-- Döviz menüsü -->
                <li class="nav-item dropdown me-2">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="fxDropdown"
                       role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-currency-exchange me-1"></i> Döviz
                        <small id="fxBadge" class="ms-2 text-muted"></small>
                    </a>

                    <div class="dropdown-menu dropdown-menu-end dropdown-menu-dark p-2" aria-labelledby="fxDropdown" style="min-width:240px">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-secondary small">Baz: <strong>USD</strong></span>
                            <span id="fxUpdated" class="text-secondary small">yükleniyor…</span>
                        </div>

                        <div id="fxList" class="d-grid gap-1 small">
                            <div class="d-flex justify-content-between">
                                <span>USD / <strong>TRY</strong></span>
                                <strong data-code="TRY">—</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>USD / <strong>EUR</strong></span>
                                <strong data-code="EUR">—</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>USD / <strong>GBP</strong></span>
                                <strong data-code="GBP">—</strong>
                            </div>
                        </div>
                    </div>
                </li>

                @if (isAuth)
                {


                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button"
                           data-bs-toggle="dropdown" aria-expanded="false">
                            <img src="@profileImage" alt="Profile" class="rounded-circle me-2"
                                 style="width:30px; height:30px; object-fit:cover;">
                            @User.Identity!.Name
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark" aria-labelledby="userDropdown">
                            <li>
                                <a class="dropdown-item" asp-action="Index" asp-controller="ProfileSettings">
                                    <i class="bi bi-person-gear me-1"></i> Profil
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" asp-controller="Purchase" asp-action="Index">
                                    <i class="bi bi-bag-check me-1"></i> Satın Aldıklarım
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item d-flex align-items-center justify-content-between"
                                   asp-controller="Chat" asp-action="Index">
                                    <span><i class="bi bi-chat-dots me-1"></i> Sohbetler</span>
                                    <span id="chatUnreadBadge" class="badge bg-danger rounded-pill" style="display:none">0</span>
                                </a>
                            </li>
                            <li><hr class="dropdown-divider" /></li>
                            <li>
                                <form asp-action="Logout" asp-controller="Auth" method="post" class="px-3 py-1">
                                    <button type="submit" class="btn btn-sm btn-outline-danger w-100">
                                        <i class="bi bi-box-arrow-right me-1"></i> Çıkış
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </li>
                }
                else
                {
                    <li class="nav-item me-2">
                        <a class="btn btn-outline-light btn-sm" asp-action="Index" asp-controller="Auth">Giriş</a>
                    </li>
                    <li class="nav-item">
                        <a class="btn btn-primary btn-sm" asp-action="Index" asp-controller="Register">Kayıt Ol</a>
                    </li>
                }
            </ul>
        </div>
    </div>
</nav>

<style>
    .navbar .nav-link {
        color: rgba(255,255,255,.85);
    }

        .navbar .nav-link:hover, .navbar .nav-link.active {
            color: #fff;
            text-decoration: underline;
            text-underline-offset: 4px;
        }

    .dropdown-menu-scroll {
        max-height: 50vh;
        overflow-y: auto;
    }

    .dropdown-menu-dark .dropdown-item {
        border-radius: .5rem;
    }

        .dropdown-menu-dark .dropdown-item:hover {
            background: rgba(255,255,255,.08);
        }

    #fxList strong[data-code] {
        font-variant-numeric: tabular-nums;
    }
</style>

<script>
    // Döviz
    (function(){
      async function loadFx(){
        const updated = document.getElementById('fxUpdated');
        const badge = document.getElementById('fxBadge');
        try{
          const res = await fetch('/api/rates?baseCode=USD&show=TRY,EUR,GBP', { cache:'no-store' });
          if(!res.ok) throw new Error('http '+res.status);
          const data = await res.json();

          const map = {};
          (data.list || []).forEach(x => map[(x.code||'').toUpperCase()] = x.rate);

          document.querySelectorAll('#fxList [data-code]').forEach(el=>{
            const code = el.getAttribute('data-code').toUpperCase();
            const v = map[code];
            el.textContent = (v != null) ? Number(v).toFixed(code==='TRY' ? 2 : 4) : '—';
          });

          const tryRate = map['TRY'];
          if(badge) badge.textContent = tryRate ? Number(tryRate).toFixed(2) : '';

          if(updated) updated.textContent = 'Güncelleme: ' + (data.last || new Date().toLocaleString());
        }catch(e){
          console.error(e);
          if(updated) updated.textContent = 'Veri alınamadı';
        }
      }
      loadFx();
      setInterval(loadFx, 300000); // 5 dk
    })();

    // Freelancer bekleyen talep sayacı
    (function(){
      const badge = document.getElementById('pendingBadgeNav');
      if(!badge) return;
      async function loadPending(){
        try{
          const r = await fetch('/api/purchase/pendingCount', { cache:'no-store' });
          if(!r.ok) return;
          const j = await r.json();
          badge.textContent = (j?.count ?? 0);
        }catch {}
      }
      loadPending();
      setInterval(loadPending, 120000); // 2 dk'da bir
    })();

      // Okunmamış sohbet sayısı (opsiyonel)
    (function(){
      const el = document.getElementById('chatUnreadBadge');
      if(!el) return;
      async function loadUnread(){
        try{
          const r = await fetch('/api/chat/unreadCount', { cache:'no-store' });
          if(!r.ok) return;
          const j = await r.json();
          const n = j?.count ?? 0;
          if(n > 0){ el.textContent = n; el.style.display = ''; }
          else { el.style.display = 'none'; }
        }catch{ /* yut */ }
      }
      loadUnread();
      setInterval(loadUnread, 120000); // 2 dk
    })();
</script>
